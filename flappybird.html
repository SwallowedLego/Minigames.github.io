<script>
  const canvas = document.getElementById('flappyCanvas');
  const ctx = canvas.getContext('2d');
  const scoreDisplay = document.getElementById('score');
  const highscoreDisplay = document.getElementById('highscore');
  const gameOverScreen = document.getElementById('gameOverScreen');
  const finalScoreDisplay = document.getElementById('finalScore');
  const countdownDisplay = document.getElementById('countdown');

  const resizeCanvas = () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  };
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const bird = { x: 50, y: 200, width: 20, height: 20, dy: 0 };
  const gravity = 0.5;
  const lift = -8;
  const pipes = [];
  const pipeWidth = 50;
  const pipeGap = 120;
  const pipeSpeed = 2;

  let score = 0;
  let highscore = localStorage.getItem('flappyHighscore') || 0;
  let isGameOver = false;
  let gameStarted = false;

  highscoreDisplay.textContent = `Highscore: ${highscore}`;

  function createPipe() {
    const pipeY = Math.floor(Math.random() * (canvas.height - pipeGap));
    pipes.push({ x: canvas.width, y: pipeY, scored: false });
  }

  function drawBird() {
    ctx.fillStyle = 'yellow';
    ctx.fillRect(bird.x, bird.y, bird.width, bird.height);
  }

  function drawPipes() {
    ctx.fillStyle = 'green';
    pipes.forEach(pipe => {
      ctx.fillRect(pipe.x, 0, pipeWidth, pipe.y); // Top pipe
      ctx.fillRect(pipe.x, pipe.y + pipeGap, pipeWidth, canvas.height - (pipe.y + pipeGap)); // Bottom pipe
    });
  }

  function moveBird() {
    bird.dy += gravity;
    bird.y += bird.dy;

    if (bird.y + bird.height > canvas.height || bird.y < 0) {
      gameOver();
    }
  }

  function movePipes() {
    pipes.forEach(pipe => {
      pipe.x -= pipeSpeed;

      // Score increment logic: Check if the bird passes the middle of the pipe
      if (!pipe.scored && pipe.x + pipeWidth < bird.x) {
        pipe.scored = true; // Mark this pipe as scored
        score++;
        scoreDisplay.textContent = `Score: ${score}`;
      }

      // Collision detection
      if (
        bird.x < pipe.x + pipeWidth &&
        bird.x + bird.width > pipe.x &&
        (bird.y < pipe.y || bird.y + bird.height > pipe.y + pipeGap)
      ) {
        gameOver();
      }
    });

    // Remove pipes that are out of view
    if (pipes.length && pipes[0].x + pipeWidth < 0) {
      pipes.shift();
    }
  }

  function gameOver() {
    isGameOver = true;
    clearInterval(pipeInterval);
    updateHighscore();
    finalScoreDisplay.textContent = `Final Score: ${score}`;
    gameOverScreen.style.display = 'block';
  }

  function updateHighscore() {
    if (score > highscore) {
      highscore = score;
      localStorage.setItem('flappyHighscore', highscore);
      highscoreDisplay.textContent = `Highscore: ${highscore}`;
    }
  }

  function restartGame() {
    bird.y = canvas.height / 2;
    bird.dy = 0;
    pipes.length = 0;
    score = 0;
    scoreDisplay.textContent = `Score: ${score}`;
    gameOverScreen.style.display = 'none';
    isGameOver = false;
    startGameWithCountdown();
  }

  function startGameWithCountdown() {
    const countdownNumbers = ['3', '2', '1', 'Go!'];
    let currentIndex = 0;

    countdownDisplay.style.display = 'block';
    countdownDisplay.textContent = countdownNumbers[currentIndex];

    function nextCountdown() {
      currentIndex++;
      if (currentIndex < countdownNumbers.length) {
        countdownDisplay.textContent = countdownNumbers[currentIndex];
        setTimeout(nextCountdown, 1000);
      } else {
        countdownDisplay.style.display = 'none';
        startGame();
      }
    }

    setTimeout(nextCountdown, 1000);
  }

  function startGame() {
    gameStarted = true;
    createPipe();
    pipeInterval = setInterval(createPipe, 2000);
    gameLoop();
  }

  function gameLoop() {
    if (isGameOver) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    moveBird();
    movePipes();
    drawBird();
    drawPipes();

    requestAnimationFrame(gameLoop);
  }

  document.addEventListener('keydown', e => {
    if (e.key === ' ' && gameStarted && !isGameOver) {
      bird.dy = lift;
    }
  });

  document.addEventListener('touchstart', e => {
    if (gameStarted && !isGameOver) {
      bird.dy = lift;
    }
  });

  startGameWithCountdown();
</script>
